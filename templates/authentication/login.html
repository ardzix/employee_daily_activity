{% extends 'base.html' %}

{% block title %}Login - Employee Daily Activity Tracker{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-4 py-12">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="mx-auto w-20 h-20 bg-nft-gradient rounded-full flex items-center justify-center mb-6">
                <i class="fas fa-clipboard-check text-white text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-white">Welcome Back</h2>
            <p class="mt-2 text-gray-400">{{ app_name }}</p>
        </div>
        
        <!-- Login Card -->
        <div class="nft-card p-8 space-y-6 rounded-xl">
            <!-- Auth Toggle -->
            <div class="flex border border-nft-light rounded-lg p-1 mb-6">
                <button type="button" id="loginTabBtn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-nft-gradient rounded-md transition-all duration-200">
                    Sign In
                </button>
                <button type="button" id="registerTabBtn" class="flex-1 px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-all duration-200">
                    Register
                </button>
            </div>
            
            <!-- Login Form -->
            <div id="loginSection">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-semibold text-white mb-2">Sign in to your account</h3>
                    <p class="text-gray-400 text-sm">Use your Arnatech credentials to continue</p>
                </div>
                
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent"
                               placeholder="your.email@arnatech.id">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent"
                               placeholder="Your password">
                    </div>
                    
                    <button type="submit" id="loginBtn"
                            class="w-full flex items-center justify-center px-4 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-nft-gradient hover:bg-nft-gradient-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-nft-primary transition-all duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span id="loginBtnText">Sign In</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden" id="loginSpinner"></i>
                    </button>
                </form>
            </div>
            
            <!-- Registration Form -->
            <div id="registerSection" class="hidden">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-semibold text-white mb-2">Create new account</h3>
                    <p class="text-gray-400 text-sm">Join Arnatech employee portal</p>
                </div>
                
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="reg_email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="reg_email" name="email" required
                               class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent"
                               placeholder="your.email@arnatech.id">
                    </div>
                    
                    <div>
                        <label for="reg_password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="reg_password" name="password" required
                               class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent"
                               placeholder="Create a strong password">
                    </div>
                    
                    <div>
                        <label for="reg_confirm_password" class="block text-sm font-medium text-gray-300 mb-1">Confirm Password</label>
                        <input type="password" id="reg_confirm_password" name="confirm_password" required
                               class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent"
                               placeholder="Confirm your password">
                    </div>
                    
                    <button type="submit" id="registerBtn"
                            class="w-full flex items-center justify-center px-4 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-nft-gradient hover:bg-nft-gradient-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-nft-primary transition-all duration-200">
                        <i class="fas fa-user-plus mr-2"></i>
                        <span id="registerBtnText">Create Account</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden" id="registerSpinner"></i>
                    </button>
                </form>
            </div>
            
            <!-- Email Verification Form -->
            <div id="verificationSection" class="hidden">
                <div class="text-center mb-6">
                    <div class="mx-auto w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-envelope text-yellow-400 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">Verify Your Email</h3>
                    <p class="text-gray-400 text-sm">We've sent a 6-digit OTP to your email address</p>
                    <p class="text-nft-primary text-sm font-medium mt-2" id="verificationEmail"></p>
                </div>
                
                <form id="verificationForm" class="space-y-4">
                    <div>
                        <label for="otp" class="block text-sm font-medium text-gray-300 mb-1">Verification Code</label>
                        <input type="text" id="otp" name="otp" maxlength="6" required
                               class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent text-center text-lg tracking-wider"
                               placeholder="000000">
                    </div>
                    
                    <button type="submit" id="verifyBtn"
                            class="w-full flex items-center justify-center px-4 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-nft-gradient hover:bg-nft-gradient-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-nft-primary transition-all duration-200">
                        <i class="fas fa-check mr-2"></i>
                        <span id="verifyBtnText">Verify Email</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden" id="verifySpinner"></i>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-gray-400 text-sm">Didn't receive the code? Check your spam folder or contact support.</p>
                        <button type="button" id="resendBtn"
                                class="text-nft-primary hover:underline text-sm font-medium mt-1">
                            Resend OTP
                        </button>
                    </div>
                    
                    <button type="button" id="backToRegisterBtn"
                            class="w-full flex items-center justify-center px-4 py-2 border border-nft-light text-gray-300 rounded-lg hover:bg-nft-gray transition-all duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Registration
                    </button>
                </form>
            </div>

            <!-- MFA Form (hidden by default) -->
            <form id="mfaForm" class="space-y-4 hidden">
                <div class="text-center mb-4">
                    <i class="fas fa-shield-alt text-nft-primary text-2xl mb-2"></i>
                    <h4 class="text-lg font-semibold text-white">Two-Factor Authentication</h4>
                    <p class="text-gray-400 text-sm">Please enter your MFA token to continue</p>
                </div>
                
                <div>
                    <label for="mfa_token" class="block text-sm font-medium text-gray-300 mb-1">MFA Token</label>
                    <input type="text" id="mfa_token" name="mfa_token" maxlength="6" required
                           class="w-full px-3 py-2 bg-nft-gray border border-nft-light rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-nft-primary focus:border-transparent text-center text-lg tracking-wider"
                           placeholder="000000">
                </div>
                
                <button type="submit" id="mfaBtn"
                        class="w-full flex items-center justify-center px-4 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-nft-gradient hover:bg-nft-gradient-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-nft-primary transition-all duration-200">
                    <i class="fas fa-check mr-2"></i>
                    <span id="mfaBtnText">Verify</span>
                    <i class="fas fa-spinner fa-spin ml-2 hidden" id="mfaSpinner"></i>
                </button>
                
                <button type="button" id="backToLoginBtn"
                        class="w-full flex items-center justify-center px-4 py-2 border border-nft-light text-gray-300 rounded-lg hover:bg-nft-gray transition-all duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Login
                </button>
            </form>
            
            <!-- Error Message -->
            <div id="errorMessage" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-400 mr-2"></i>
                    <span class="text-red-400 text-sm" id="errorText"></span>
                </div>
            </div>
            
            <!-- Success Message -->
            <div id="successMessage" class="hidden p-3 bg-green-500/20 border border-green-500/50 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    <span class="text-green-400 text-sm" id="successText"></span>
                </div>
            </div>
            
            <!-- Features -->
            <div class="border-t border-nft-light pt-6">
                <h4 class="text-sm font-medium text-gray-300 mb-3">What you can do:</h4>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-nft-primary mr-2"></i>
                        Daily check-in and check-out
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-nft-primary mr-2"></i>
                        Track goals and activities
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-nft-primary mr-2"></i>
                        View activity history
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-nft-primary mr-2"></i>
                        Receive attendance insights
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Help -->
        <div class="text-center">
            <p class="text-sm text-gray-400">
                Need help? Contact 
                <a href="mailto:support@arnatech.id" class="text-nft-primary hover:underline">
                    support@arnatech.id
                </a>
            </p>
        </div>
    </div>
</div>

<!-- Background Animation -->
<div class="fixed inset-0 -z-10 overflow-hidden">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-nft-primary/10 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-nft-secondary/10 rounded-full blur-3xl animate-pulse"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEmail = '';
let isRegistering = false;

// Tab switching
document.getElementById('loginTabBtn').addEventListener('click', () => switchTab('login'));
document.getElementById('registerTabBtn').addEventListener('click', () => switchTab('register'));

function switchTab(tab) {
    const loginTab = document.getElementById('loginTabBtn');
    const registerTab = document.getElementById('registerTabBtn');
    const loginSection = document.getElementById('loginSection');
    const registerSection = document.getElementById('registerSection');
    
    hideAllForms();
    hideMessages();
    
    if (tab === 'login') {
        loginTab.classList.add('bg-nft-gradient', 'text-white');
        loginTab.classList.remove('text-gray-400');
        registerTab.classList.remove('bg-nft-gradient', 'text-white');
        registerTab.classList.add('text-gray-400');
        
        loginSection.classList.remove('hidden');
        registerSection.classList.add('hidden');
        isRegistering = false;
    } else {
        registerTab.classList.add('bg-nft-gradient', 'text-white');
        registerTab.classList.remove('text-gray-400');
        loginTab.classList.remove('bg-nft-gradient', 'text-white');
        loginTab.classList.add('text-gray-400');
        
        registerSection.classList.remove('hidden');
        loginSection.classList.add('hidden');
        isRegistering = true;
    }
}

// Registration form handler
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('reg_email').value;
    const password = document.getElementById('reg_password').value;
    const confirmPassword = document.getElementById('reg_confirm_password').value;
    
    // Validate password match
    if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
    }
    
    // Show loading state
    setLoadingState('register', true);
    hideMessages();
    
    try {
        const response = await fetch('/auth/api/register/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Registration successful, show verification form
            currentEmail = email;
            showVerificationForm();
            showSuccess('Registration successful! Please check your email for verification code.');
        } else {
            showError(data.error || 'Registration failed');
        }
    } catch (error) {
        showError('Network error. Please try again.');
    } finally {
        setLoadingState('register', false);
    }
});

// Email verification form handler
document.getElementById('verificationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const otp = document.getElementById('otp').value;
    
    // Show loading state
    setLoadingState('verify', true);
    hideMessages();
    
    try {
        const response = await fetch('/auth/api/verify-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                email: currentEmail, 
                otp: otp 
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Email verification successful
            showSuccess('Email verified successfully! You can now sign in.');
            setTimeout(() => {
                switchTab('login');
                // Pre-fill login email
                document.getElementById('email').value = currentEmail;
            }, 2000);
        } else {
            showError(data.error || 'Email verification failed');
        }
    } catch (error) {
        showError('Network error. Please try again.');
    } finally {
        setLoadingState('verify', false);
    }
});

// Resend OTP handler
document.getElementById('resendBtn').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.textContent = 'Sending...';
    
    try {
        const response = await fetch('/auth/api/resend-email-otp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: currentEmail })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSuccess('OTP resent successfully! Check your email.');
            btn.textContent = 'Resent!';
            setTimeout(() => {
                btn.textContent = 'Resend OTP';
                btn.disabled = false;
            }, 60000); // 1 minute delay
        } else {
            showError(data.error || 'Failed to resend OTP');
            btn.textContent = 'Resend OTP';
            btn.disabled = false;
        }
    } catch (error) {
        showError('Network error. Please try again.');
        btn.textContent = 'Resend OTP';
        btn.disabled = false;
    }
});

// Login form handler
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    // Show loading state
    setLoadingState('login', true);
    hideMessages();
    
    try {
        const response = await fetch('/auth/api/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.mfa_required) {
                // Show MFA form
                currentEmail = email;
                showMFAForm();
            } else if (data.success) {
                // Login successful, redirect
                window.location.href = data.redirect_url || '/dashboard/';
            }
        } else {
            showError(data.error || 'Login failed');
        }
    } catch (error) {
        showError('Network error. Please try again.');
    } finally {
        setLoadingState('login', false);
    }
});

// MFA form handler
document.getElementById('mfaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const mfaToken = document.getElementById('mfa_token').value;
    
    // Show loading state
    setLoadingState('mfa', true);
    hideMessages();
    
    try {
        const response = await fetch('/auth/api/mfa/verify/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                email: currentEmail, 
                mfa_token: mfaToken 
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // MFA verification successful, redirect
            window.location.href = data.redirect_url || '/dashboard/';
        } else {
            showError(data.error || 'MFA verification failed');
        }
    } catch (error) {
        showError('Network error. Please try again.');
    } finally {
        setLoadingState('mfa', false);
    }
});

// Navigation buttons
document.getElementById('backToLoginBtn').addEventListener('click', function() {
    showLoginForm();
    document.getElementById('password').value = ''; // Clear password for security
});

document.getElementById('backToRegisterBtn').addEventListener('click', function() {
    showRegisterForm();
});

// Helper functions
function showVerificationForm() {
    hideAllForms();
    document.getElementById('verificationSection').classList.remove('hidden');
    document.getElementById('verificationEmail').textContent = currentEmail;
    document.getElementById('otp').focus();
}

function showMFAForm() {
    hideAllForms();
    document.getElementById('mfaForm').classList.remove('hidden');
    document.getElementById('mfa_token').focus();
}

function showLoginForm() {
    hideAllForms();
    switchTab('login');
    document.getElementById('mfa_token').value = '';
}

function showRegisterForm() {
    hideAllForms();
    switchTab('register');
}

function hideAllForms() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('registerSection').classList.add('hidden');
    document.getElementById('verificationSection').classList.add('hidden');
    document.getElementById('mfaForm').classList.add('hidden');
}

function setLoadingState(form, loading) {
    const states = {
        login: { btn: 'loginBtn', text: 'loginBtnText', spinner: 'loginSpinner', loadingText: 'Signing In...', normalText: 'Sign In' },
        register: { btn: 'registerBtn', text: 'registerBtnText', spinner: 'registerSpinner', loadingText: 'Creating Account...', normalText: 'Create Account' },
        verify: { btn: 'verifyBtn', text: 'verifyBtnText', spinner: 'verifySpinner', loadingText: 'Verifying...', normalText: 'Verify Email' },
        mfa: { btn: 'mfaBtn', text: 'mfaBtnText', spinner: 'mfaSpinner', loadingText: 'Verifying...', normalText: 'Verify' }
    };
    
    const state = states[form];
    if (state) {
        const btn = document.getElementById(state.btn);
        const text = document.getElementById(state.text);
        const spinner = document.getElementById(state.spinner);
        
        btn.disabled = loading;
        text.textContent = loading ? state.loadingText : state.normalText;
        spinner.classList.toggle('hidden', !loading);
    }
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
        errorDiv.classList.add('hidden');
    }, 8000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    const successText = document.getElementById('successText');
    
    successText.textContent = message;
    successDiv.classList.remove('hidden');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        successDiv.classList.add('hidden');
    }, 5000);
}

function hideMessages() {
    document.getElementById('errorMessage').classList.add('hidden');
    document.getElementById('successMessage').classList.add('hidden');
}

// Auto-focus and validation for OTP inputs
document.getElementById('otp').addEventListener('input', function(e) {
    // Only allow numbers
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
    
    // Auto-submit when 6 digits are entered
    if (e.target.value.length === 6) {
        document.getElementById('verificationForm').dispatchEvent(new Event('submit'));
    }
});

// Auto-focus MFA input when typing numbers
document.getElementById('mfa_token').addEventListener('input', function(e) {
    // Only allow numbers
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
    
    // Auto-submit when 6 digits are entered
    if (e.target.value.length === 6) {
        document.getElementById('mfaForm').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %} 