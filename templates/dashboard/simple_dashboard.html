{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Employee Activity Tracker{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">Welcome!</h1>
                <p class="text-blue-300">{{ user.username }}</p>
            </div>
            
            <div class="flex items-center space-x-4">
                {% if is_admin %}
                <a href="{% url 'dashboard:admin' %}" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-cog mr-2"></i>Admin Panel
                </a>
                {% endif %}
                
                <a href="{% url 'authentication:logout' %}" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </div>
        </div>

        <!-- Status Card -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20 shadow-xl">
            <div class="flex items-center space-x-4">
                <div class="p-3 bg-yellow-500/20 rounded-xl">
                    <i class="fas fa-user-clock text-yellow-400 text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-white mb-1">Profile Setup in Progress</h3>
                    <p class="text-blue-300">{{ message }}</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Quick Actions -->
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i class="fas fa-bolt text-yellow-400 mr-3"></i>
                    Quick Actions
                </h2>
                
                <div class="space-y-4">
                    <button id="check-in-btn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-4 px-6 rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2">
                        <i class="fas fa-clock text-xl"></i>
                        <span class="text-lg font-semibold">Clock In</span>
                    </button>
                    
                    <button id="check-out-btn" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 px-6 rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2">
                        <i class="fas fa-clock text-xl"></i>
                        <span class="text-lg font-semibold">Clock Out</span>
                    </button>
                    
                    <a href="{% url 'authentication:profile' %}" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 px-6 rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2 block">
                        <i class="fas fa-user text-xl"></i>
                        <span class="text-lg font-semibold">View Profile</span>
                    </a>
                    
                    <a href="{% url 'activities:activity_data' %}" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-4 px-6 rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2 block">
                        <i class="fas fa-database text-xl"></i>
                        <span class="text-lg font-semibold">View Activity Data</span>
                    </a>
                </div>
            </div>

            <!-- User Information -->
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i class="fas fa-user text-blue-400 mr-3"></i>
                    Your Information
                </h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center py-2 border-b border-white/10">
                        <span class="text-blue-300">Username:</span>
                        <span class="text-white font-semibold">{{ user.username }}</span>
                    </div>
                    
                    {% if user.email %}
                    <div class="flex justify-between items-center py-2 border-b border-white/10">
                        <span class="text-blue-300">Email:</span>
                        <span class="text-white font-semibold">{{ user.email }}</span>
                    </div>
                    {% endif %}
                    
                    {% if user.first_name or user.last_name %}
                    <div class="flex justify-between items-center py-2 border-b border-white/10">
                        <span class="text-blue-300">Name:</span>
                        <span class="text-white font-semibold">{{ user.first_name }} {{ user.last_name }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="flex justify-between items-center py-2 border-b border-white/10">
                        <span class="text-blue-300">Status:</span>
                        <span class="bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-sm">Profile Setup Pending</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Notice -->
        <div class="mt-8 bg-blue-600/20 border border-blue-500/30 rounded-2xl p-6">
            <div class="flex items-start space-x-4">
                <i class="fas fa-info-circle text-blue-400 text-xl mt-1"></i>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">Next Steps</h3>
                    <ul class="text-blue-300 space-y-1">
                        <li>• Your HR department will complete your employee profile setup</li>
                        <li>• You'll gain access to full features once your profile is ready</li>
                        <li>• In the meantime, you can use basic clock in/out functionality</li>
                        <li>• Contact HR if you have any questions about your account</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Check-in Modal -->
<div id="check-in-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <i class="fas fa-clock text-green-400 mr-3"></i>
                    Clock In
                </h2>
                <button id="close-checkin-modal" class="text-white hover:text-red-400 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="check-in-form" class="space-y-6">
                {% csrf_token %}
                
                <!-- Planned Activities Section -->
                <div>
                    <label class="block text-white font-semibold mb-3">
                        <i class="fas fa-list-ul mr-2"></i>What do you plan to do today? *
                    </label>
                    <div id="planned-activities-container" class="space-y-3">
                        <div class="planned-activity-item flex items-center space-x-3">
                            <input 
                                type="text" 
                                name="planned_activity_title_1"
                                required
                                class="flex-1 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter planned activity..."
                            >
                            <select name="planned_activity_priority_1" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1" class="bg-gray-800">Low</option>
                                <option value="2" class="bg-gray-800" selected>Medium</option>
                                <option value="3" class="bg-gray-800">High</option>
                                <option value="4" class="bg-gray-800">Critical</option>
                            </select>
                            <button type="button" class="remove-activity text-red-400 hover:text-red-300 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="add-activity" class="mt-3 bg-blue-600/20 text-blue-400 px-4 py-2 rounded-lg hover:bg-blue-600/30 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Add Another Activity
                    </button>
                </div>
                
                <!-- Daily Goals Section -->
                <div>
                    <label class="block text-white font-semibold mb-3">
                        <i class="fas fa-bullseye mr-2"></i>Daily Goals *
                    </label>
                    <div id="daily-goals-container" class="space-y-3">
                        <div class="daily-goal-item flex items-center space-x-3">
                            <input 
                                type="text" 
                                name="daily_goal_title_1"
                                required
                                class="flex-1 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter daily goal..."
                            >
                            <input 
                                type="text" 
                                name="daily_goal_target_1"
                                class="w-32 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Target"
                            >
                            <select name="daily_goal_priority_1" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1" class="bg-gray-800">Low</option>
                                <option value="2" class="bg-gray-800" selected>Medium</option>
                                <option value="3" class="bg-gray-800">High</option>
                                <option value="4" class="bg-gray-800">Critical</option>
                            </select>
                            <button type="button" class="remove-goal text-red-400 hover:text-red-300 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="add-goal" class="mt-3 bg-green-600/20 text-green-400 px-4 py-2 rounded-lg hover:bg-green-600/30 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Add Another Goal
                    </button>
                </div>
                
                <!-- Morning Problems -->
                <div>
                    <label class="block text-white font-semibold mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Problems or Blockers
                    </label>
                    <textarea 
                        name="morning_problems" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Any problems or blockers you're facing? (optional)"
                        rows="3"
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-checkin" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-clock mr-2"></i>Clock In
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Check-out Modal -->
<div id="check-out-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <i class="fas fa-clock text-blue-400 mr-3"></i>
                    Clock Out
                </h2>
                <button id="close-checkout-modal" class="text-white hover:text-red-400 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="check-out-form" class="space-y-6">
                {% csrf_token %}
                
                <!-- Planned Activities Status -->
                <div id="planned-activities-status" class="hidden">
                    <h3 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-list-ul mr-2"></i>Planned Activities Status
                    </h3>
                    <div id="activities-status-container" class="space-y-3"></div>
                </div>
                
                <!-- Daily Goals Status -->
                <div id="daily-goals-status" class="hidden">
                    <h3 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-bullseye mr-2"></i>Daily Goals Status
                    </h3>
                    <div id="goals-status-container" class="space-y-3"></div>
                </div>
                
                <!-- Additional Activities -->
                <div>
                    <label class="block text-white font-semibold mb-3">
                        <i class="fas fa-plus-circle mr-2"></i>Additional Activities (Done outside planned work)
                    </label>
                    <div id="additional-activities-container" class="space-y-3">
                        <!-- Additional activities will be added dynamically -->
                    </div>
                    <button type="button" id="add-additional-activity" class="mt-3 bg-purple-600/20 text-purple-400 px-4 py-2 rounded-lg hover:bg-purple-600/30 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Add Additional Activity
                    </button>
                </div>
                
                <!-- Afternoon Problems -->
                <div>
                    <label class="block text-white font-semibold mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Problems or Issues
                    </label>
                    <textarea 
                        name="afternoon_problems" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Any problems or issues you encountered today?"
                        rows="3"
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-checkout" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-clock mr-2"></i>Clock Out
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkInBtn = document.getElementById('check-in-btn');
    const checkOutBtn = document.getElementById('check-out-btn');
    const checkInModal = document.getElementById('check-in-modal');
    const checkOutModal = document.getElementById('check-out-modal');
    const checkInForm = document.getElementById('check-in-form');
    const checkOutForm = document.getElementById('check-out-form');
    
    let activityCounter = 1;
    let goalCounter = 1;
    let additionalActivityCounter = 0;
    
    // Modal controls
    document.getElementById('close-checkin-modal').addEventListener('click', () => {
        checkInModal.classList.add('hidden');
    });
    
    document.getElementById('cancel-checkin').addEventListener('click', () => {
        checkInModal.classList.add('hidden');
    });
    
    document.getElementById('close-checkout-modal').addEventListener('click', () => {
        checkOutModal.classList.add('hidden');
    });
    
    document.getElementById('cancel-checkout').addEventListener('click', () => {
        checkOutModal.classList.add('hidden');
    });
    
    // Close modal when clicking outside
    checkInModal.addEventListener('click', (e) => {
        if (e.target === checkInModal) {
            checkInModal.classList.add('hidden');
        }
    });
    
    checkOutModal.addEventListener('click', (e) => {
        if (e.target === checkOutModal) {
            checkOutModal.classList.add('hidden');
        }
    });
    
    // Add Activity functionality
    document.getElementById('add-activity').addEventListener('click', function() {
        activityCounter++;
        const container = document.getElementById('planned-activities-container');
        const activityItem = document.createElement('div');
        activityItem.className = 'planned-activity-item flex items-center space-x-3';
        activityItem.innerHTML = `
            <input 
                type="text" 
                name="planned_activity_title_${activityCounter}"
                required
                class="flex-1 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Enter planned activity..."
            >
            <select name="planned_activity_priority_${activityCounter}" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1" class="bg-gray-800">Low</option>
                <option value="2" class="bg-gray-800" selected>Medium</option>
                <option value="3" class="bg-gray-800">High</option>
                <option value="4" class="bg-gray-800">Critical</option>
            </select>
            <button type="button" class="remove-activity text-red-400 hover:text-red-300 p-2">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(activityItem);
        
        // Add remove functionality
        activityItem.querySelector('.remove-activity').addEventListener('click', function() {
            activityItem.remove();
        });
    });
    
    // Add Goal functionality
    document.getElementById('add-goal').addEventListener('click', function() {
        goalCounter++;
        const container = document.getElementById('daily-goals-container');
        const goalItem = document.createElement('div');
        goalItem.className = 'daily-goal-item flex items-center space-x-3';
        goalItem.innerHTML = `
            <input 
                type="text" 
                name="daily_goal_title_${goalCounter}"
                required
                class="flex-1 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Enter daily goal..."
            >
            <input 
                type="text" 
                name="daily_goal_target_${goalCounter}"
                class="w-32 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Target"
            >
            <select name="daily_goal_priority_${goalCounter}" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1" class="bg-gray-800">Low</option>
                <option value="2" class="bg-gray-800" selected>Medium</option>
                <option value="3" class="bg-gray-800">High</option>
                <option value="4" class="bg-gray-800">Critical</option>
            </select>
            <button type="button" class="remove-goal text-red-400 hover:text-red-300 p-2">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(goalItem);
        
        // Add remove functionality
        goalItem.querySelector('.remove-goal').addEventListener('click', function() {
            goalItem.remove();
        });
    });
    
    // Add remove functionality to initial activity and goal
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-activity')) {
            const activityItems = document.querySelectorAll('.planned-activity-item');
            if (activityItems.length > 1) {
                e.target.closest('.planned-activity-item').remove();
            }
        }
        if (e.target.closest('.remove-goal')) {
            const goalItems = document.querySelectorAll('.daily-goal-item');
            if (goalItems.length > 1) {
                e.target.closest('.daily-goal-item').remove();
            }
        }
    });
    
    // Add Additional Activity functionality
    document.getElementById('add-additional-activity').addEventListener('click', function() {
        additionalActivityCounter++;
        const container = document.getElementById('additional-activities-container');
        const activityItem = document.createElement('div');
        activityItem.className = 'additional-activity-item bg-white/5 rounded-lg p-4 space-y-3';
        activityItem.innerHTML = `
            <div class="flex items-center justify-between">
                <h4 class="text-white font-medium">Additional Activity #${additionalActivityCounter}</h4>
                <button type="button" class="remove-additional-activity text-red-400 hover:text-red-300">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <input 
                    type="text" 
                    name="additional_activity_title_${additionalActivityCounter}"
                    required
                    class="bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Activity title..."
                >
                <select name="additional_activity_category_${additionalActivityCounter}" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="urgent" class="bg-gray-800 text-white">Urgent Task</option>
                    <option value="meeting" class="bg-gray-800 text-white">Unplanned Meeting</option>
                    <option value="support" class="bg-gray-800 text-white">Support/Help</option>
                    <option value="research" class="bg-gray-800 text-white">Research</option>
                    <option value="admin" class="bg-gray-800 text-white">Administrative</option>
                    <option value="other" class="bg-gray-800 text-white" selected>Other</option>
                </select>
            </div>
            <textarea 
                name="additional_activity_description_${additionalActivityCounter}"
                class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Describe what you did..."
                rows="2"
            ></textarea>
            <textarea 
                name="additional_activity_impact_${additionalActivityCounter}"
                class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="How did this affect your planned work? (optional)"
                rows="2"
            ></textarea>
        `;
        container.appendChild(activityItem);
        
        // Add remove functionality
        activityItem.querySelector('.remove-additional-activity').addEventListener('click', function() {
            activityItem.remove();
        });
    });
    
    // Get CSRF token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               '{{ csrf_token }}';
    }
    
    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        } text-white`;
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Handle check-in button click
    checkInBtn.addEventListener('click', function() {
        checkInModal.classList.remove('hidden');
    });
    
    // Handle check-out button click
    checkOutBtn.addEventListener('click', function() {
        // Load current activity data for check-out
        loadCheckoutData();
        checkOutModal.classList.remove('hidden');
    });
    
    // Load checkout data
    function loadCheckoutData() {
        fetch('/activities/api/status/')
        .then(response => response.json())
        .then(data => {
            if (data.checkin_data) {
                populateCheckoutForm(data.checkin_data);
            }
        })
        .catch(error => {
            console.error('Error loading checkout data:', error);
        });
    }
    
    // Populate checkout form with check-in data
    function populateCheckoutForm(checkinData) {
        const activitiesContainer = document.getElementById('activities-status-container');
        const goalsContainer = document.getElementById('goals-status-container');
        const activitiesSection = document.getElementById('planned-activities-status');
        const goalsSection = document.getElementById('daily-goals-status');
        
        // Clear containers
        activitiesContainer.innerHTML = '';
        goalsContainer.innerHTML = '';
        
        // Populate planned activities
        if (checkinData.planned_activities && checkinData.planned_activities.length > 0) {
            activitiesSection.classList.remove('hidden');
            checkinData.planned_activities.forEach(activity => {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'bg-white/5 rounded-lg p-4 space-y-3';
                activityDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h4 class="text-white font-medium">${activity.title}</h4>
                        <span class="text-sm text-gray-400">Priority: ${['', 'Low', 'Medium', 'High', 'Critical'][activity.priority]}</span>
                    </div>
                    <div class="space-y-3">
                        <select name="activity_status_${activity.id}" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 activity-status-select">
                            <option value="" class="bg-gray-800 text-white">Select status...</option>
                            <option value="completed" class="bg-gray-800 text-white">Completed</option>
                            <option value="in_progress" class="bg-gray-800 text-white">In Progress</option>
                            <option value="not_completed" class="bg-gray-800 text-white">Not Completed</option>
                            <option value="cancelled" class="bg-gray-800 text-white">Cancelled</option>
                            <option value="deferred" class="bg-gray-800 text-white">Deferred</option>
                        </select>
                        <div class="activity-reasons-container" style="display: none;">
                            <textarea 
                                name="activity_reasons_${activity.id}"
                                class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent activity-reasons-field"
                                placeholder="Reason (required if not completed)"
                                rows="3"
                            ></textarea>
                        </div>
                    </div>
                `;
                activitiesContainer.appendChild(activityDiv);
                
                // Add event listener for status change
                const statusSelect = activityDiv.querySelector('.activity-status-select');
                const reasonsContainer = activityDiv.querySelector('.activity-reasons-container');
                const reasonsField = activityDiv.querySelector('.activity-reasons-field');
                
                statusSelect.addEventListener('change', function() {
                    const requiresReason = ['not_completed', 'cancelled', 'deferred'].includes(this.value);
                    
                    if (requiresReason) {
                        reasonsContainer.style.display = 'block';
                        reasonsField.setAttribute('required', 'required');
                    } else {
                        reasonsContainer.style.display = 'none';
                        reasonsField.removeAttribute('required');
                        reasonsField.value = ''; // Clear the field when hidden
                    }
                });
            });
        }
        
        // Populate daily goals
        if (checkinData.daily_goals && checkinData.daily_goals.length > 0) {
            goalsSection.classList.remove('hidden');
            checkinData.daily_goals.forEach(goal => {
                const goalDiv = document.createElement('div');
                goalDiv.className = 'bg-white/5 rounded-lg p-4 space-y-3';
                goalDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h4 class="text-white font-medium">${goal.title}</h4>
                        <span class="text-sm text-gray-400">Target: ${goal.target_value || 'Not set'}</span>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <select name="goal_status_${goal.id}" required class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 goal-status-select">
                                <option value="" class="bg-gray-800 text-white">Select status...</option>
                                <option value="completed" class="bg-gray-800 text-white">Completed</option>
                                <option value="partially_completed" class="bg-gray-800 text-white">Partially Completed</option>
                                <option value="not_achieved" class="bg-gray-800 text-white">Not Achieved</option>
                                <option value="in_progress" class="bg-gray-800 text-white">In Progress</option>
                                <option value="deferred" class="bg-gray-800 text-white">Deferred</option>
                            </select>
                            <input 
                                type="text" 
                                name="goal_achieved_value_${goal.id}"
                                class="bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Achieved value"
                            >
                        </div>
                        <div class="goal-completion-container" style="display: none;">
                            <input 
                                type="number" 
                                name="goal_completion_${goal.id}"
                                min="0" max="100"
                                class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent goal-completion-field"
                                placeholder="Completion percentage (0-100)"
                            >
                        </div>
                        <div class="goal-reasons-container" style="display: none;">
                            <textarea 
                                name="goal_reasons_${goal.id}"
                                class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent goal-reasons-field"
                                placeholder="Reason (required if not achieved or partially completed)"
                                rows="3"
                            ></textarea>
                        </div>
                    </div>
                `;
                goalsContainer.appendChild(goalDiv);
                
                // Add event listener for status change
                const statusSelect = goalDiv.querySelector('.goal-status-select');
                const reasonsContainer = goalDiv.querySelector('.goal-reasons-container');
                const reasonsField = goalDiv.querySelector('.goal-reasons-field');
                const completionContainer = goalDiv.querySelector('.goal-completion-container');
                const completionField = goalDiv.querySelector('.goal-completion-field');
                
                statusSelect.addEventListener('change', function() {
                    const requiresReason = ['not_achieved', 'partially_completed', 'deferred'].includes(this.value);
                    const isPartiallyCompleted = this.value === 'partially_completed';
                    
                    // Handle reasons field
                    if (requiresReason) {
                        reasonsContainer.style.display = 'block';
                        reasonsField.setAttribute('required', 'required');
                    } else {
                        reasonsContainer.style.display = 'none';
                        reasonsField.removeAttribute('required');
                        reasonsField.value = ''; // Clear the field when hidden
                    }
                    
                    // Handle completion percentage field
                    if (isPartiallyCompleted) {
                        completionContainer.style.display = 'block';
                        completionField.setAttribute('required', 'required');
                    } else {
                        completionContainer.style.display = 'none';
                        completionField.removeAttribute('required');
                        completionField.value = ''; // Clear the field when hidden
                    }
                });
            });
        }
    }
    
    // Handle check-in form submission
    checkInForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        // Collect planned activities
        const activityTitles = [];
        const activityPriorities = [];
        
        document.querySelectorAll('.planned-activity-item').forEach((item, index) => {
            const title = item.querySelector(`input[name*="planned_activity_title"]`).value;
            const priority = item.querySelector(`select[name*="planned_activity_priority"]`).value;
            if (title) {
                activityTitles.push({
                    title: title,
                    priority: parseInt(priority),
                    order: index + 1
                });
            }
        });
        
        // Collect daily goals
        const goalTitles = [];
        document.querySelectorAll('.daily-goal-item').forEach((item, index) => {
            const title = item.querySelector(`input[name*="daily_goal_title"]`).value;
            const target = item.querySelector(`input[name*="daily_goal_target"]`).value;
            const priority = item.querySelector(`select[name*="daily_goal_priority"]`).value;
            if (title) {
                goalTitles.push({
                    title: title,
                    target_value: target,
                    priority: parseInt(priority),
                    order: index + 1
                });
            }
        });
        
        formData.append('planned_activities', JSON.stringify(activityTitles));
        formData.append('daily_goals', JSON.stringify(goalTitles));
        formData.append('morning_problems', document.querySelector('textarea[name="morning_problems"]').value);
        
        const submitBtn = checkInForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking In...';
        
        fetch('/activities/api/check-in/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                checkInModal.classList.add('hidden');
                checkInForm.reset();
                // Reset counters and containers
                activityCounter = 1;
                goalCounter = 1;
                document.getElementById('planned-activities-container').innerHTML = `
                    <div class="planned-activity-item flex items-center space-x-3">
                        <input 
                            type="text" 
                            name="planned_activity_title_1"
                            required
                            class="flex-1 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter planned activity..."
                        >
                        <select name="planned_activity_priority_1" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1" class="bg-gray-800">Low</option>
                            <option value="2" class="bg-gray-800" selected>Medium</option>
                            <option value="3" class="bg-gray-800">High</option>
                            <option value="4" class="bg-gray-800">Critical</option>
                        </select>
                        <button type="button" class="remove-activity text-red-400 hover:text-red-300 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                document.getElementById('daily-goals-container').innerHTML = `
                    <div class="daily-goal-item flex items-center space-x-3">
                        <input 
                            type="text" 
                            name="daily_goal_title_1"
                            required
                            class="flex-1 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter daily goal..."
                        >
                        <input 
                            type="text" 
                            name="daily_goal_target_1"
                            class="w-32 bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Target"
                        >
                        <select name="daily_goal_priority_1" class="bg-white/10 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1" class="bg-gray-800">Low</option>
                            <option value="2" class="bg-gray-800" selected>Medium</option>
                            <option value="3" class="bg-gray-800">High</option>
                            <option value="4" class="bg-gray-800">Critical</option>
                        </select>
                        <button type="button" class="remove-goal text-red-400 hover:text-red-300 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                updateStatus();
            } else if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                showNotification(data.error || 'Check-in failed', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
    
    // Handle check-out form submission
    checkOutForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        // Collect activity updates
        const activityUpdates = [];
        document.querySelectorAll('[name^="activity_status_"]').forEach(select => {
            const activityId = select.name.split('_').pop();
            const status = select.value;
            const reasons = document.querySelector(`[name="activity_reasons_${activityId}"]`).value;
            
            if (status) {
                activityUpdates.push({
                    id: parseInt(activityId),
                    status: status,
                    reasons: reasons
                });
            }
        });
        
        // Collect goal updates
        const goalUpdates = [];
        document.querySelectorAll('[name^="goal_status_"]').forEach(select => {
            const goalId = select.name.split('_').pop();
            const status = select.value;
            const reasons = document.querySelector(`[name="goal_reasons_${goalId}"]`).value;
            const achievedValue = document.querySelector(`[name="goal_achieved_value_${goalId}"]`).value;
            const completion = document.querySelector(`[name="goal_completion_${goalId}"]`).value;
            
            if (status) {
                goalUpdates.push({
                    id: parseInt(goalId),
                    status: status,
                    reasons: reasons,
                    achieved_value: achievedValue,
                    completion_percentage: completion ? parseInt(completion) : 0
                });
            }
        });
        
        // Collect additional activities
        const additionalActivities = [];
        document.querySelectorAll('.additional-activity-item').forEach((item, index) => {
            const title = item.querySelector(`[name*="additional_activity_title"]`).value;
            const category = item.querySelector(`[name*="additional_activity_category"]`).value;
            const description = item.querySelector(`[name*="additional_activity_description"]`).value;
            const impact = item.querySelector(`[name*="additional_activity_impact"]`).value;
            
            if (title) {
                additionalActivities.push({
                    title: title,
                    category: category,
                    description: description,
                    impact_on_planned_work: impact,
                    status: 'completed',
                    order: index + 1
                });
            }
        });
        
        formData.append('activity_updates', JSON.stringify(activityUpdates));
        formData.append('goal_updates', JSON.stringify(goalUpdates));
        formData.append('additional_activities', JSON.stringify(additionalActivities));
        formData.append('afternoon_problems', document.querySelector('textarea[name="afternoon_problems"]').value);
        
        const submitBtn = checkOutForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking Out...';
        
        fetch('/activities/api/check-out/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                checkOutModal.classList.add('hidden');
                checkOutForm.reset();
                // Reset additional activities counter
                additionalActivityCounter = 0;
                document.getElementById('additional-activities-container').innerHTML = '';
                updateStatus();
            } else if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                showNotification(data.error || 'Check-out failed', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
    
    // Update button visibility based on current status
    function updateStatus() {
        fetch('/activities/api/status/')
        .then(response => response.json())
        .then(data => {
            if (data.checked_out) {
                checkInBtn.style.display = 'none';
                checkOutBtn.style.display = 'none';
            } else if (data.checked_in) {
                checkInBtn.style.display = 'none';
                checkOutBtn.style.display = 'flex';
            } else {
                checkInBtn.style.display = 'flex';
                checkOutBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
        });
    }
    
    // Initialize status on page load
    updateStatus();
});
</script>
{% endblock %} 